<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>太阳周日运动轨迹3D模拟器 - 高中地理教学工具</title>
    <style>
        /* 样式保持不变，与原始代码相同 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .simulation-container {
            flex: 1;
            min-width: 600px;
            height: 500px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            position: relative;
        }
        
        #earth-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 10px;
            min-width: 180px;
        }
        
        .info-panel h3 {
            margin-bottom: 10px;
            color: #ffcc00;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 5px;
        }
        
        .info-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .info-label {
            font-weight: 500;
        }
        
        .info-value {
            color: #4fc3f7;
        }
        
        .controls {
            flex: 0 0 300px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 5px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .slider-container label {
            width: 120px;
            font-weight: 500;
        }
        
        .slider-container input {
            flex: 1;
            margin: 0 10px;
        }
        
        .slider-container span {
            width: 60px;
            text-align: right;
        }
        
        .option-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .latitude-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .option-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .option-button:hover {
            background: #388E3C;
            transform: translateY(-2px);
        }
        
        .option-button.active {
            background: #ff5722;
            box-shadow: 0 0 8px rgba(255, 87, 34, 0.7);
        }
        
        .season-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .season-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .season-button:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }
        
        .season-button.active {
            background: #ff5722;
            box-shadow: 0 0 10px rgba(255, 87, 34, 0.7);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            background: #ff9800;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
        }
        
        button:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }
        
        .bottom-panels {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .panel h3 {
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 5px;
        }
        
        .trajectory-recording {
            /* 保持原有样式，但移除了一些重复的样式 */
        }
        
        .recording-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .recording-button {
            background: #9C27B0;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
        }
        
        .recording-button:hover {
            background: #7B1FA2;
            transform: translateY(-2px);
        }
        
        .recording-button.active {
            background: #E91E63;
            box-shadow: 0 0 10px rgba(233, 30, 99, 0.7);
        }
        
        .recording-button.clear {
            background: #f44336;
        }
        
        .recording-button.clear:hover {
            background: #d32f2f;
        }
        
        .recording-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .recording-stats span {
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .explanation {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
        }
        
        .explanation h2 {
            margin-bottom: 15px;
            font-size: 1.8rem;
            color: #ffcc00;
        }
        
        .explanation-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .explanation-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
        }
        
        .explanation-box h3 {
            margin-bottom: 10px;
            color: #4fc3f7;
        }
        
        .explanation-box p {
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }
        
        .sun-color {
            background: #ffcc00;
        }
        
        .trajectory-color {
            background: #ff4444;
        }
        
        .recorded-trajectory-color {
            background: #9C27B0;
        }
        
        .horizon-color {
            background: #4CAF50;
        }
        
        .celestial-color {
            background: #4fc3f7;
        }
        
        @media (max-width: 1000px) {
            .content {
                flex-direction: column;
            }
            
            .simulation-container {
                min-width: 100%;
            }
            
            .controls {
                width: 100%;
            }
            
            .option-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .latitude-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .bottom-panels {
                flex-direction: column;
            }
        }
        
        /* 新增样式 - 真太阳时信息 */
        .time-info {
            /* 移除部分样式，因为现在使用.panel通用样式 */
        }
        
        .time-info h4 {
            margin-bottom: 10px;
            color: #ffcc00;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }
        
        .time-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .time-info-label {
            font-weight: 500;
        }
        
        .time-info-value {
            color: #4fc3f7;
        }
        
        /* 开发信息模块样式 */
        .dev-info {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .dev-info p {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .dev-info .highlight {
            color: #ffcc00;
            font-weight: bold;
        }
        
        .dev-info .acknowledgment {
            margin-top: 15px;
            font-style: italic;
            color: #4fc3f7;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>太阳周日运动轨迹3D模拟器</h1>
            <p class="subtitle">一个用于高中地理教学的工具，展示太阳在不同纬度、日期和时间下的周日视运动轨迹。通过调整参数，观察太阳轨迹如何随季节和地理位置变化。</p>
        </header>
        
        <div class="content">
            <div class="simulation-container">
                <canvas id="earth-canvas"></canvas>
                <div class="info-panel">
                    <h3>太阳位置信息</h3>
                    <div class="info-item">
                        <span class="info-label">高度角:</span>
                        <span class="info-value" id="altitude-value">0°</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">方位角:</span>
                        <span class="info-value" id="azimuth-value">90°</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">日出时间:</span>
                        <span class="info-value" id="sunrise-value">06:00</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">日落时间:</span>
                        <span class="info-value" id="sunset-value">18:00</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">昼长:</span>
                        <span class="info-value" id="daylight-duration">12小时</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">日出方位:</span>
                        <span class="info-value" id="sunrise-azimuth">东</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">日落方位:</span>
                        <span class="info-value" id="sunset-azimuth">西</span>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <h3>地理位置设置</h3>
                    <div class="slider-container">
                        <label for="latitude">纬度:</label>
                        <input type="range" id="latitude" min="-90" max="90" value="40" step="1">
                        <span id="latitude-value">40°N</span>
                    </div>
                    
                    <div class="latitude-buttons">
                        <button class="option-button" data-lat="0">0°</button>
                        <button class="option-button" data-lat="23.43">23°26'N</button>
                        <button class="option-button" data-lat="-23.43">23°26'S</button>
                        <button class="option-button" data-lat="66.57">66°34'N</button>
                        <button class="option-button" data-lat="-66.57">66°34'S</button>
                        <button class="option-button" data-lat="90">90°N</button>
                        <button class="option-button" data-lat="-90">90°S</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>日期设置</h3>
                    <div class="slider-container">
                        <label for="date">日期:</label>
                        <input type="range" id="date" min="0" max="365" value="172" step="1">
                        <span id="date-value">6月21日</span>
                    </div>
                    
                    <div class="season-buttons">
                        <button class="season-button" id="spring-equinox">春分</button>
                        <button class="season-button" id="summer-solstice">夏至</button>
                        <button class="season-button" id="autumn-equinox">秋分</button>
                        <button class="season-button" id="winter-solstice">冬至</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>时间设置</h3>
                    <div class="slider-container">
                        <label for="time">时间:</label>
                        <input type="range" id="time" min="0" max="24" value="12" step="0.1">
                        <span id="time-value">12:00</span>
                    </div>
                    
                    <div class="option-buttons">
                        <button class="option-button" data-time="6">6:00</button>
                        <button class="option-button" data-time="12">12:00</button>
                        <button class="option-button" data-time="18">18:00</button>
                        <button class="option-button" data-time="24">24:00</button>
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="play-pause">暂停</button>
                    <button id="reset">重置</button>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color sun-color"></div>
                        <span>太阳</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color trajectory-color"></div>
                        <span>太阳轨迹</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color recorded-trajectory-color"></div>
                        <span>记录轨迹</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color horizon-color"></div>
                        <span>地平线</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color celestial-color"></div>
                        <span>天球</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 底部面板：太阳时信息、轨迹记录和开发信息 -->
        <div class="bottom-panels">
            <div class="panel time-info">
                <h3>太阳时信息</h3>
                <div class="time-info-item">
                    <span class="time-info-label">地方时:</span>
                    <span class="time-info-value" id="mean-solar-time">12:00</span>
                </div>
                <div class="time-info-item">
                    <span class="time-info-label">时差:</span>
                    <span class="time-info-value" id="equation-of-time">+0分钟</span>
                </div>
                <div class="time-info-item">
                    <span class="time-info-label">真太阳时:</span>
                    <span class="time-info-value" id="true-solar-time">12:00</span>
                </div>
                <div class="time-info-item">
                    <span class="time-info-label">正午时刻:</span>
                    <span class="time-info-value" id="solar-noon">12:00</span>
                </div>
            </div>
            
            <div class="panel trajectory-recording">
                <h3>轨迹记录</h3>
                <div class="recording-buttons">
                    <button class="recording-button" id="start-recording">开始记录</button>
                    <button class="recording-button" id="pause-recording">暂停记录</button>
                    <button class="recording-button clear" id="clear-recording">清除记录</button>
                </div>
                <div class="recording-stats">
                    <span>记录点数: <span id="recorded-points">0</span></span>
                    <span>状态: <span id="recording-status">未记录</span></span>
                </div>
            </div>
            
            <div class="panel dev-info">
                <h3>开发信息</h3>
                <p><span class="highlight">项目名称:</span> 太阳视运动轨迹模拟器</p>
                <p><span class="highlight">开发者:</span> 徐宜青</p>
                <p><span class="highlight">年份:</span> 2025</p>
                <p class="acknowledgment">特别鸣谢: Deepseek</p>
            </div>
        </div>
        
        <div class="explanation">
            <h2>教学说明</h2>
            <div class="explanation-content">
                <div class="explanation-box">
                    <h3>太阳周日视运动</h3>
                    <p>太阳周日视运动是指从地球观察者视角看到的太阳在一天中的运动轨迹。这种运动是由地球自转引起的，表现为太阳每天东升西落的现象。</p>
                </div>
                
                <div class="explanation-box">
                    <h3>高度角和方位角</h3>
                    <p>太阳高度角是太阳光线与地平面之间的夹角，方位角是太阳光线在地平面上的投影与正北方向之间的夹角。这两个参数决定了太阳在天空中的位置。</p>
                </div>
                
                <div class="explanation-box">
                    <h3>二分二至日</h3>
                    <p>春分、夏至、秋分、冬至是地球公转轨道上的四个关键点，分别对应太阳直射赤道、北回归线、赤道和南回归线。这些日期对太阳轨迹有显著影响。</p>
                </div>
                
                <div class="explanation-box">
                    <h3>真太阳时与地方时</h3>
                    <p>真太阳时是基于太阳实际位置的当地时间，地方时是基于经度的本地时间。两者差异称为"时差"，由地球轨道偏心率和黄赤交角引起，全年变化在-14到+16分钟之间。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入Three.js库 -->
    <script src="three.min.js"></script>
    <script src="OrbitControls.min.js"></script>
    
    <script>
        // 初始化变量
        let scene, camera, renderer, controls;
        let ground, observer, sun, trajectory, celestialSphere, horizonCircle, sky;
        let latitude = 40; // 默认纬度（北半球）
        let date = 172; // 默认日期（夏至）
        let time = 12; // 默认时间（12:00）- 这里表示地方时
        let isPlaying = true;
        let animationId;
        const CELESTIAL_RADIUS = 15; // 天球半径
        
        // 轨迹记录相关变量
        let isRecording = false;
        let recordedPoints = [];
        let recordedTrajectory;
        let recordingInterval = 0.1; // 记录间隔（小时）
        let lastRecordedTime = 0;
        
        // 光照相关变量
        let ambientLight, directionalLight;
        
        // 二分二至日对应的日期
        const SEASON_DATES = {
            'spring-equinox': 80,   // 春分
            'summer-solstice': 172, // 夏至
            'autumn-equinox': 266,  // 秋分
            'winter-solstice': 355  // 冬至
        };
        
        // 月份天数（非闰年）
        const MONTH_DAYS = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        
        // 初始化场景
        function init() {
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x001122);
            
            // 创建相机
            camera = new THREE.PerspectiveCamera(60, 600 / 500, 0.1, 1000);
            camera.position.set(0, 10, 15);
            
            // 创建渲染器
            const canvas = document.getElementById('earth-canvas');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.shadowMap.enabled = true;
            
            // 添加轨道控制
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // 添加环境光
            ambientLight = new THREE.AmbientLight(0x333333, 0.3);
            scene.add(ambientLight);
            
            // 添加方向光（模拟太阳光）
            directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // 创建天空半球（白天黑夜效果）
            createSky();
            
            // 创建地面
            const groundGeometry = new THREE.CircleGeometry(CELESTIAL_RADIUS, 32);
            const groundMaterial = new THREE.MeshPhongMaterial({
                color: 0x4CAF50,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.7
            });
            ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);
            
            // 创建天球（透明半球罩子）
            createCelestialSphere();
            
            // 创建方位标记
            createCompass();
            
            // 创建观测者（柱子）
            const observerGeometry = new THREE.CylinderGeometry(0.1, 0.1, 2, 16);
            const observerMaterial = new THREE.MeshPhongMaterial({ color: 0x888888 });
            observer = new THREE.Mesh(observerGeometry, observerMaterial);
            observer.position.y = 1;
            scene.add(observer);
            
            // 创建太阳 - 修改：将半径从0.3改为0.7
            const sunGeometry = new THREE.SphereGeometry(0.7, 16, 16);
            const sunMaterial = new THREE.MeshBasicMaterial({ color: 0xffcc00 });
            sun = new THREE.Mesh(sunGeometry, sunMaterial);
            scene.add(sun);
            
            // 创建太阳轨迹 - 使用更粗的线
            const trajectoryGeometry = new THREE.BufferGeometry();
            const trajectoryMaterial = new THREE.LineDashedMaterial({
                color: 0xff4444,
                linewidth: 4, // 增加线宽
                dashSize: 0.2,
                gapSize: 0.1
            });
            trajectory = new THREE.Line(trajectoryGeometry, trajectoryMaterial);
            scene.add(trajectory);
            
            // 创建记录轨迹
            const recordedTrajectoryGeometry = new THREE.BufferGeometry();
            const recordedTrajectoryMaterial = new THREE.LineBasicMaterial({
                color: 0x9C27B0,
                linewidth: 3
            });
            recordedTrajectory = new THREE.Line(recordedTrajectoryGeometry, recordedTrajectoryMaterial);
            scene.add(recordedTrajectory);
            
            // 更新太阳位置
            updateSunPosition();
            
            // 处理窗口大小变化
            window.addEventListener('resize', onWindowResize);
            
            // 开始动画循环
            animate();
        }
        
        // 创建天空半球（白天黑夜效果）
        function createSky() {
            const skyGeometry = new THREE.SphereGeometry(40, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2);
            const skyMaterial = new THREE.MeshBasicMaterial({
                color: 0x87CEEB,
                side: THREE.BackSide,
                transparent: true,
                opacity: 0.8
            });
            sky = new THREE.Mesh(skyGeometry, skyMaterial);
            scene.add(sky);
        }
        
        // 更新天空颜色和光照（根据太阳高度）- 修复版
        function updateSkyAndLighting() {
            // 计算时差
            const equationOfTime = calculateEquationOfTime(date);
            
            // 计算真太阳时
            const trueSolarTime = calculateTrueSolarTime(time, equationOfTime);
            
            // 计算太阳高度角
            const { altitude } = calculateSunPosition(trueSolarTime);
            
            // 更新天空颜色和光照
            updateSkyColor(altitude);
            updateSceneLighting(altitude);
        }
        
        // 更新天空颜色（根据太阳高度）- 修复版
        function updateSkyColor(altitude) {
            // 根据太阳高度调整天空颜色
            if (altitude > 6) {
                // 白天 - 天蓝色
                sky.material.color.setRGB(0.53, 0.81, 0.92);
                sky.material.opacity = 0.8;
            } else if (altitude > -6) {
                // 日出日落和晨昏蒙影时段 - 橙红色调
                // 在-6度到6度之间使用橙红色，亮度随高度变化
                const factor = (altitude + 6) / 12; // 将-6到6映射到0到1
                const r = 0.9 * factor + 0.1;
                const g = 0.5 * factor + 0.1;
                const b = 0.2 * factor + 0.1;
                
                sky.material.color.setRGB(r, g, b);
                sky.material.opacity = 0.8;
            } else {
                // 夜晚 - 深蓝色
                sky.material.color.setRGB(0.05, 0.05, 0.2);
                sky.material.opacity = 0.9;
            }
        }
        
        // 更新场景光照（根据太阳高度）- 修复版
        function updateSceneLighting(altitude) {
            // 更新环境光强度
            if (altitude > 0) {
                // 白天
                const intensity = Math.min(1, altitude / 90);
                ambientLight.intensity = 0.3 * intensity;
            } else if (altitude > -6) {
                // 晨昏蒙影
                const factor = (altitude + 6) / 6;
                ambientLight.intensity = 0.3 * factor;
            } else {
                // 夜晚
                ambientLight.intensity = 0.05;
            }
            
            // 更新方向光强度和颜色
            if (altitude > 6) {
                // 白天
                const intensity = Math.min(1, altitude / 90);
                directionalLight.intensity = intensity;
                directionalLight.color.setRGB(1, 1, 1);
            } else if (altitude > -6) {
                // 日出日落和晨昏蒙影时段 - 暖色调
                const factor = (altitude + 6) / 12; // 将-6到6映射到0到1
                directionalLight.intensity = factor;
                directionalLight.color.setRGB(1, 0.8 * factor, 0.6 * factor);
            } else {
                // 夜晚 - 无直射光
                directionalLight.intensity = 0;
            }
            
            // 更新场景背景色
            if (altitude > 6) {
                // 白天 - 天蓝色背景
                scene.background.setRGB(0.53, 0.81, 0.92);
            } else if (altitude > -6) {
                // 日出日落和晨昏蒙影 - 橙红色背景
                const factor = (altitude + 6) / 12; // 将-6到6映射到0到1
                scene.background.setRGB(0.9 * factor, 0.5 * factor, 0.2 * factor);
            } else {
                // 夜晚 - 深蓝色背景
                scene.background.setRGB(0.02, 0.02, 0.1);
            }
        }
        
        // 创建天球（透明半球罩子）
        function createCelestialSphere() {
            // 创建天球半球
            const sphereGeometry = new THREE.SphereGeometry(CELESTIAL_RADIUS, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2);
            const sphereMaterial = new THREE.MeshBasicMaterial({
                color: 0x4fc3f7,
                transparent: true,
                opacity: 0.1,
                wireframe: true,
                side: THREE.DoubleSide
            });
            celestialSphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
            celestialSphere.position.y = 0;
            scene.add(celestialSphere);
            
            // 创建地平圈（与天球半径相同）
            const horizonGeometry = new THREE.RingGeometry(CELESTIAL_RADIUS - 0.1, CELESTIAL_RADIUS, 64);
            const horizonMaterial = new THREE.MeshBasicMaterial({
                color: 0x4CAF50,
                transparent: true,
                opacity: 0.5,
                side: THREE.DoubleSide
            });
            horizonCircle = new THREE.Mesh(horizonGeometry, horizonMaterial);
            horizonCircle.rotation.x = Math.PI / 2;
            scene.add(horizonCircle);
            
            // 添加天球赤道线
            const equatorGeometry = new THREE.RingGeometry(CELESTIAL_RADIUS - 0.1, CELESTIAL_RADIUS, 64);
            const equatorMaterial = new THREE.MeshBasicMaterial({
                color: 0x4fc3f7,
                transparent: true,
                opacity: 0.3,
                side: THREE.DoubleSide
            });
            const equator = new THREE.Mesh(equatorGeometry, equatorMaterial);
            equator.rotation.x = Math.PI / 2;
            scene.add(equator);
        }
        
        // 创建方位标记
        function createCompass() {
            // 创建两条独立的线段：东西线和南北线
            const eastWestGeometry = new THREE.BufferGeometry();
            const northSouthGeometry = new THREE.BufferGeometry();
            
            // 东西线顶点（从西到东）
            const eastWestVertices = new Float32Array([
                -CELESTIAL_RADIUS, 0.01, 0,  // 西
                CELESTIAL_RADIUS, 0.01, 0    // 东
            ]);
            
            // 南北线顶点（从北到南）
            const northSouthVertices = new Float32Array([
                0, 0.01, -CELESTIAL_RADIUS,  // 北
                0, 0.01, CELESTIAL_RADIUS    // 南
            ]);
            
            eastWestGeometry.setAttribute('position', new THREE.BufferAttribute(eastWestVertices, 3));
            northSouthGeometry.setAttribute('position', new THREE.BufferAttribute(northSouthVertices, 3));
            
            const lineMaterial = new THREE.LineDashedMaterial({
                color: 0xffffff,
                linewidth: 1,
                dashSize: 0.5,
                gapSize: 0.5
            });
            
            // 创建两条独立的线段
            const eastWestLine = new THREE.Line(eastWestGeometry, lineMaterial);
            const northSouthLine = new THREE.Line(northSouthGeometry, lineMaterial);
            
            eastWestLine.computeLineDistances();
            northSouthLine.computeLineDistances();
            
            scene.add(eastWestLine);
            scene.add(northSouthLine);
            
            // 创建方位文字（使用E、S、W、N，更大更清晰）
            createDirectionLabel('N', 0, 1.5, -CELESTIAL_RADIUS + 1);  // 北
            createDirectionLabel('S', 0, 1.5, CELESTIAL_RADIUS - 1);   // 南
            createDirectionLabel('E', CELESTIAL_RADIUS - 1, 1.5, 0);   // 东
            createDirectionLabel('W', -CELESTIAL_RADIUS + 1, 1.5, 0);  // 西
        }
        
        // 创建方向标签
        function createDirectionLabel(text, x, y, z) {
            // 创建文本精灵
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 256;  // 增大尺寸
            canvas.height = 128; // 增大尺寸
            
            // 绘制文本
            context.fillStyle = 'white';
            context.font = 'bold 100px Arial'; // 增大字体
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(text, canvas.width / 2, canvas.height / 2);
            
            // 创建纹理
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({ 
                map: texture,
                transparent: true
            });
            
            // 创建精灵
            const sprite = new THREE.Sprite(material);
            sprite.position.set(x, y, z);
            sprite.scale.set(3, 1.5, 1); // 增大精灵尺寸
            
            scene.add(sprite);
        }
        
        // 计算时差 (Equation of Time) - 真太阳时与平太阳时的差异
        function calculateEquationOfTime(dayOfYear) {
            // 使用更精确的时差计算公式
            const B = (2 * Math.PI / 365) * (dayOfYear - 81);
            const EoT = 9.87 * Math.sin(2 * B) - 7.53 * Math.cos(B) - 1.5 * Math.sin(B);
            return EoT; // 返回单位为分钟
        }
        
        // 计算真太阳时（修改为仅使用地方时和时差）
        function calculateTrueSolarTime(meanSolarTime, equationOfTime) {
            // 真太阳时 = 地方时 + 时差
            const trueSolarTimeMinutes = meanSolarTime * 60 + equationOfTime;
            
            // 转换为小时并确保在0-24范围内
            let trueSolarTimeHours = trueSolarTimeMinutes / 60;
            while (trueSolarTimeHours < 0) trueSolarTimeHours += 24;
            while (trueSolarTimeHours >= 24) trueSolarTimeHours -= 24;
            
            return trueSolarTimeHours;
        }
        
        // 计算正午时刻（太阳高度角最大的时刻）
        function calculateSolarNoon(equationOfTime) {
            // 正午时刻 = 12:00 - 时差/60 小时
            const noonCorrection = equationOfTime / 60;
            let solarNoon = 12 - noonCorrection;
            
            // 确保在0-24范围内
            while (solarNoon < 0) solarNoon += 24;
            while (solarNoon >= 24) solarNoon -= 24;
            
            return solarNoon;
        }
        
        // 更新太阳位置
        function updateSunPosition() {
            // 计算时差
            const equationOfTime = calculateEquationOfTime(date);
            
            // 计算真太阳时
            const trueSolarTime = calculateTrueSolarTime(time, equationOfTime);
            
            // 计算正午时刻
            const solarNoon = calculateSolarNoon(equationOfTime);
            
            // 更新真太阳时信息显示
            updateTrueSolarTimeInfo(equationOfTime, trueSolarTime, solarNoon);
            
            // 计算太阳高度角和方位角（使用真太阳时）
            const { altitude, azimuth } = calculateSunPosition(trueSolarTime);
            
            // 更新信息面板
            document.getElementById('altitude-value').textContent = `${altitude.toFixed(1)}°`;
            document.getElementById('azimuth-value').textContent = `${azimuth.toFixed(1)}°`;
            
            // 计算日出日落时间和方位（使用真太阳时，但显示地方时）
            const { sunrise, sunset, sunriseAzimuth, sunsetAzimuth, daylightDuration } = calculateSunriseSunset();
            document.getElementById('sunrise-value').textContent = sunrise;
            document.getElementById('sunset-value').textContent = sunset;
            document.getElementById('daylight-duration').textContent = daylightDuration;
            document.getElementById('sunrise-azimuth').textContent = sunriseAzimuth;
            document.getElementById('sunset-azimuth').textContent = sunsetAzimuth;
            
            // 设置太阳位置（在天球上）
            const distance = CELESTIAL_RADIUS; // 天球半径
            
            // 将高度角和方位角转换为3D坐标
            const altitudeRad = altitude * Math.PI / 180;
            const azimuthRad = (azimuth) * Math.PI / 180; // 方位角从北开始
            
            // 修正坐标计算，确保太阳在轨迹上
            sun.position.x = distance * Math.cos(altitudeRad) * Math.sin(azimuthRad);
            sun.position.y = distance * Math.sin(altitudeRad);
            sun.position.z = distance * Math.cos(altitudeRad) * Math.cos(azimuthRad);
            
            // 更新天空颜色和光照
            updateSkyAndLighting();
            
            // 更新太阳轨迹
            updateTrajectory();
            
            // 更新记录轨迹
            updateRecordedTrajectory();
            
            // 更新观测者影子（简化处理）
            updateShadow();
            
            // 记录太阳位置（如果正在记录）
            recordSunPosition();
        }
        
        // 更新真太阳时信息显示
        function updateTrueSolarTimeInfo(equationOfTime, trueSolarTime, solarNoon) {
            // 更新时差显示
            const eotSign = equationOfTime >= 0 ? '+' : '';
            document.getElementById('equation-of-time').textContent = `${eotSign}${equationOfTime.toFixed(1)}分钟`;
            
            // 更新地方时显示
            const meanHour = Math.floor(time);
            const meanMinute = Math.floor((time - meanHour) * 60);
            document.getElementById('mean-solar-time').textContent = 
                `${meanHour.toString().padStart(2, '0')}:${meanMinute.toString().padStart(2, '0')}`;
            
            // 更新真太阳时显示
            const trueHour = Math.floor(trueSolarTime);
            const trueMinute = Math.floor((trueSolarTime - trueHour) * 60);
            document.getElementById('true-solar-time').textContent = 
                `${trueHour.toString().padStart(2, '0')}:${trueMinute.toString().padStart(2, '0')}`;
            
            // 更新正午时刻显示
            const noonHour = Math.floor(solarNoon);
            const noonMinute = Math.floor((solarNoon - noonHour) * 60);
            document.getElementById('solar-noon').textContent = 
                `${noonHour.toString().padStart(2, '0')}:${noonMinute.toString().padStart(2, '0')}`;
        }
        
        // 记录太阳位置
        function recordSunPosition() {
            if (!isRecording) return;
            
            // 在暂停状态下，直接记录而不检查时间间隔
            if (!isPlaying) {
                // 复制当前太阳位置
                const point = sun.position.clone();
                recordedPoints.push(point);
                
                // 更新记录点数显示
                document.getElementById('recorded-points').textContent = recordedPoints.length;
                return;
            }
            
            // 在播放状态下，检查是否达到记录间隔
            if (Math.abs(time - lastRecordedTime) >= recordingInterval) {
                // 复制当前太阳位置
                const point = sun.position.clone();
                recordedPoints.push(point);
                
                // 更新最后记录时间
                lastRecordedTime = time;
                
                // 更新记录点数显示
                document.getElementById('recorded-points').textContent = recordedPoints.length;
            }
        }
        
        // 更新记录轨迹
        function updateRecordedTrajectory() {
            recordedTrajectory.geometry.setFromPoints(recordedPoints);
        }
        
        // 开始记录轨迹
        function startRecording() {
            isRecording = true;
            document.getElementById('recording-status').textContent = '记录中';
            document.getElementById('start-recording').classList.add('active');
            document.getElementById('pause-recording').classList.remove('active');
            
            // 重置最后记录时间，确保从当前时间开始记录
            lastRecordedTime = time;
        }
        
        // 暂停记录轨迹
        function pauseRecording() {
            isRecording = false;
            document.getElementById('recording-status').textContent = '已暂停';
            document.getElementById('start-recording').classList.remove('active');
            document.getElementById('pause-recording').classList.add('active');
        }
        
        // 清除记录轨迹
        function clearRecording() {
            recordedPoints = [];
            recordedTrajectory.geometry.setFromPoints(recordedPoints);
            document.getElementById('recorded-points').textContent = '0';
            document.getElementById('recording-status').textContent = '未记录';
            document.getElementById('start-recording').classList.remove('active');
            document.getElementById('pause-recording').classList.remove('active');
        }
        
        // 计算太阳位置（高度角和方位角）- 现在接受真太阳时作为参数
        function calculateSunPosition(trueSolarTime) {
            // 计算太阳赤纬
            const dayOfYear = date;
            const declination = 23.45 * Math.sin(2 * Math.PI * (284 + dayOfYear) / 365);
            
            // 计算时角 - 使用真太阳时
            const latRad = latitude * Math.PI / 180;
            const decRad = declination * Math.PI / 180;
            const hourAngle = (trueSolarTime - 12) * 15 * Math.PI / 180;
            
            // 计算太阳高度角
            const sinAltitude = Math.sin(latRad) * Math.sin(decRad) + 
                               Math.cos(latRad) * Math.cos(decRad) * Math.cos(hourAngle);
            const altitude = Math.asin(Math.max(-1, Math.min(1, sinAltitude))) * 180 / Math.PI;
            
            // 计算太阳方位角
            let azimuth;
            if (Math.abs(altitude - 90) < 0.1) {
                // 太阳在头顶正上方，方位角不确定
                azimuth = 0;
            } else {
                const cosAzimuth = (Math.sin(decRad) - Math.sin(latRad) * Math.sin(altitude * Math.PI / 180)) / 
                                  (Math.cos(latRad) * Math.cos(altitude * Math.PI / 180));
                let azimuthRad = Math.acos(Math.max(-1, Math.min(1, cosAzimuth)));
                
                // 修正方位角方向（上午为负，下午为正）
                if (trueSolarTime < 12) {
                    azimuthRad = -azimuthRad;
                }
                
                azimuth = azimuthRad * 180 / Math.PI + 180; // 转换为从北开始的角度
                
                // 确保方位角在0-360度范围内
                if (azimuth < 0) azimuth += 360;
                if (azimuth >= 360) azimuth -= 360;
            }
            
            return { altitude, azimuth };
        }
        
        // 计算日出日落时间和方位 - 现在显示地方时
        function calculateSunriseSunset() {
            // 计算太阳赤纬
            const dayOfYear = date;
            const declination = 23.45 * Math.sin(2 * Math.PI * (284 + dayOfYear) / 365);
            
            // 计算日出日落时角
            const latRad = latitude * Math.PI / 180;
            const decRad = declination * Math.PI / 180;
            const cosHourAngle = -Math.tan(latRad) * Math.tan(decRad);
            
            // 检查是否出现极昼或极夜
            if (cosHourAngle >= 1) {
                // 极夜
                return {
                    sunrise: "无日出",
                    sunset: "无日落",
                    sunriseAzimuth: "-",
                    sunsetAzimuth: "-",
                    daylightDuration: "0小时"
                };
            } else if (cosHourAngle <= -1) {
                // 极昼
                return {
                    sunrise: "无日出",
                    sunset: "无日落",
                    sunriseAzimuth: "-",
                    sunsetAzimuth: "-",
                    daylightDuration: "24小时"
                };
            }
            
            const hourAngle = Math.acos(cosHourAngle) * 180 / Math.PI;
            
            // 计算日出日落时间（真太阳时）
            const sunriseSolarTime = 12 - hourAngle / 15;
            const sunsetSolarTime = 12 + hourAngle / 15;
            
            // 将真太阳时转换为地方时
            const equationOfTime = calculateEquationOfTime(date);
            
            // 计算地方时的日出日落时间
            const meanSunriseTime = sunriseSolarTime - equationOfTime / 60;
            const meanSunsetTime = sunsetSolarTime - equationOfTime / 60;
            
            // 格式化时间（地方时）
            const sunriseHour = Math.floor(meanSunriseTime);
            const sunriseMinute = Math.round((meanSunriseTime - sunriseHour) * 60);
            const sunsetHour = Math.floor(meanSunsetTime);
            const sunsetMinute = Math.round((meanSunsetTime - sunsetHour) * 60);
            
            const sunrise = `${sunriseHour.toString().padStart(2, '0')}:${sunriseMinute.toString().padStart(2, '0')}`;
            const sunset = `${sunsetHour.toString().padStart(2, '0')}:${sunsetMinute.toString().padStart(2, '0')}`;
            
            // 计算昼长
            const daylightHours = meanSunsetTime - meanSunriseTime;
            const daylightHour = Math.floor(daylightHours);
            const daylightMinute = Math.round((daylightHours - daylightHour) * 60);
            const daylightDuration = `${daylightHour}小时${daylightMinute}分钟`;
            
            // 计算日出日落方位角
            // 日出方位角公式：cos(azimuth) = sin(δ) / cos(φ)
            // 其中δ是太阳赤纬，φ是地理纬度
            const cosSunriseAzimuth = Math.sin(decRad) / Math.cos(latRad);
            let sunriseAzimuthRad = Math.acos(Math.max(-1, Math.min(1, cosSunriseAzimuth)));
            let sunriseAzimuth = sunriseAzimuthRad * 180 / Math.PI;
            
            // 修正日出方位角方向
            // 北半球：夏至日日出在东北，冬至日日出在东南
            // 南半球：夏至日日出在东南，冬至日日出在东北
            if (latitude >= 0) {
                // 北半球
                if (declination > 0) {
                    // 夏季（太阳直射北半球）
                    sunriseAzimuth = 90 - sunriseAzimuth;
                } else {
                    // 冬季（太阳直射南半球）
                    sunriseAzimuth = 90 + sunriseAzimuth;
                }
            } else {
                // 南半球
                if (declination > 0) {
                    // 夏季（太阳直射北半球）
                    sunriseAzimuth = 90 + sunriseAzimuth;
                } else {
                    // 冬季（太阳直射南半球）
                    sunriseAzimuth = 90 - sunriseAzimuth;
                }
            }
            
            // 日落方位角与日出方位角对称
            let sunsetAzimuth = 360 - sunriseAzimuth;
            
            // 确保方位角在0-360度范围内
            if (sunriseAzimuth < 0) sunriseAzimuth += 360;
            if (sunriseAzimuth >= 360) sunriseAzimuth -= 360;
            if (sunsetAzimuth < 0) sunsetAzimuth += 360;
            if (sunsetAzimuth >= 360) sunsetAzimuth -= 360;
            
            // 将方位角转换为方向描述
            const sunriseDirection = getDirectionFromAzimuth(sunriseAzimuth);
            const sunsetDirection = getDirectionFromAzimuth(sunsetAzimuth);
            
            return {
                sunrise,
                sunset,
                sunriseAzimuth: `${sunriseDirection} (${sunriseAzimuth.toFixed(1)}°)`,
                sunsetAzimuth: `${sunsetDirection} (${sunsetAzimuth.toFixed(1)}°)`,
                daylightDuration
            };
        }
        
        // 根据方位角获取方向描述
        function getDirectionFromAzimuth(azimuth) {
            const directions = ['北', '东北', '东', '东南', '南', '西南', '西', '西北'];
            const index = Math.round(azimuth / 45) % 8;
            return directions[index];
        }
        
        // 将一年中的第几天转换为月日
        function dayOfYearToDate(dayOfYear) {
            let month = 0;
            let day = dayOfYear;
            
            for (let i = 0; i < MONTH_DAYS.length; i++) {
                if (day < MONTH_DAYS[i]) {
                    month = i + 1;
                    day = day + 1; // 因为dayOfYear从0开始，所以加1得到日期
                    break;
                }
                day -= MONTH_DAYS[i];
            }
            
            return `${month}月${day}日`;
        }
        
        // 更新太阳轨迹 - 修复高纬度轨迹显示问题
        function updateTrajectory() {
            const points = [];
            
            // 计算太阳赤纬
            const dayOfYear = date;
            const declination = 23.45 * Math.sin(2 * Math.PI * (284 + dayOfYear) / 365);
            
            // 计算日出日落时角
            const latRad = latitude * Math.PI / 180;
            const decRad = declination * Math.PI / 180;
            const cosHourAngle = -Math.tan(latRad) * Math.tan(decRad);
            
            // 检查是否出现极昼或极夜
            let startTime = 0;
            let endTime = 24;
            
            if (Math.abs(cosHourAngle) <= 1) {
                // 正常情况，有日出日落
                const hourAngle = Math.acos(cosHourAngle) * 180 / Math.PI;
                startTime = 12 - hourAngle / 15;
                endTime = 12 + hourAngle / 15;
            } else if (cosHourAngle > 1) {
                // 极夜情况，太阳始终在地平线以下
                startTime = 0;
                endTime = 0;
            } else {
                // 极昼情况，太阳始终在地平线以上
                startTime = 0;
                endTime = 24;
            }
            
            // 极地特殊处理 - 使用更多采样点确保轨迹圆滑
            let step;
            if (Math.abs(latitude) > 85) {
                // 极地地区使用更小的步长和更多的采样点
                step = 0.02; // 极地地区使用更小的步长
                
                // 如果是极昼或极夜，生成完整的圆形轨迹
                if (Math.abs(cosHourAngle) > 1) {
                    // 生成完整的圆形轨迹
                    for (let azimuth = 0; azimuth < 360; azimuth += 1) {
                        const altitude = (Math.abs(cosHourAngle) > 1) ? 
                            (cosHourAngle > 1 ? -10 : 10) : 0; // 极夜时轨迹在地平线下，极昼时在地平线上
                        
                        const altitudeRad = altitude * Math.PI / 180;
                        const azimuthRad = azimuth * Math.PI / 180;
                        
                        const x = CELESTIAL_RADIUS * Math.cos(altitudeRad) * Math.sin(azimuthRad);
                        const y = CELESTIAL_RADIUS * Math.sin(altitudeRad);
                        const z = CELESTIAL_RADIUS * Math.cos(altitudeRad) * Math.cos(azimuthRad);
                        
                        points.push(new THREE.Vector3(x, y, z));
                    }
                } else {
                    // 正常极地轨迹计算
                    for (let t = startTime; t <= endTime; t += step) {
                        // 计算时角 - 使用真太阳时
                        const hourAngle = (t - 12) * 15 * Math.PI / 180;
                        
                        // 计算太阳高度角
                        const sinAltitude = Math.sin(latRad) * Math.sin(decRad) + 
                                           Math.cos(latRad) * Math.cos(decRad) * Math.cos(hourAngle);
                        const altitude = Math.asin(Math.max(-1, Math.min(1, sinAltitude))) * 180 / Math.PI;
                        
                        // 计算太阳方位角
                        let azimuth;
                        if (Math.abs(altitude - 90) < 0.1) {
                            azimuth = 0;
                        } else {
                            const cosAzimuth = (Math.sin(decRad) - Math.sin(latRad) * Math.sin(altitude * Math.PI / 180)) / 
                                              (Math.cos(latRad) * Math.cos(altitude * Math.PI / 180));
                            let azimuthRad = Math.acos(Math.max(-1, Math.min(1, cosAzimuth)));
                            
                            // 修正方位角方向（上午为负，下午为正）
                            if (t < 12) {
                                azimuthRad = -azimuthRad;
                            }
                            
                            azimuth = azimuthRad * 180 / Math.PI + 180; // 转换为从北开始的角度
                            
                            // 确保方位角在0-360度范围内
                            if (azimuth < 0) azimuth += 360;
                            if (azimuth >= 360) azimuth -= 360;
                        }
                        
                        // 将高度角和方位角转换为3D坐标
                        const altitudeRad = altitude * Math.PI / 180;
                        const azimuthRad = (azimuth) * Math.PI / 180; // 方位角从北开始
                        
                        const distance = CELESTIAL_RADIUS;
                        const x = distance * Math.cos(altitudeRad) * Math.sin(azimuthRad);
                        const y = distance * Math.sin(altitudeRad);
                        const z = distance * Math.cos(altitudeRad) * Math.cos(azimuthRad);
                        
                        points.push(new THREE.Vector3(x, y, z));
                    }
                }
            } else {
                // 非极地地区使用正常步长
                step = 0.1;
                
                for (let t = startTime; t <= endTime; t += step) {
                    // 计算时角 - 使用真太阳时
                    const hourAngle = (t - 12) * 15 * Math.PI / 180;
                    
                    // 计算太阳高度角
                    const sinAltitude = Math.sin(latRad) * Math.sin(decRad) + 
                                       Math.cos(latRad) * Math.cos(decRad) * Math.cos(hourAngle);
                    const altitude = Math.asin(Math.max(-1, Math.min(1, sinAltitude))) * 180 / Math.PI;
                    
                    // 计算太阳方位角
                    let azimuth;
                    if (Math.abs(altitude - 90) < 0.1) {
                        azimuth = 0;
                    } else {
                        const cosAzimuth = (Math.sin(decRad) - Math.sin(latRad) * Math.sin(altitude * Math.PI / 180)) / 
                                          (Math.cos(latRad) * Math.cos(altitude * Math.PI / 180));
                        let azimuthRad = Math.acos(Math.max(-1, Math.min(1, cosAzimuth)));
                        
                        // 修正方位角方向（上午为负，下午为正）
                        if (t < 12) {
                            azimuthRad = -azimuthRad;
                        }
                        
                        azimuth = azimuthRad * 180 / Math.PI + 180; // 转换为从北开始的角度
                        
                        // 确保方位角在0-360度范围内
                        if (azimuth < 0) azimuth += 360;
                        if (azimuth >= 360) azimuth -= 360;
                    }
                    
                    // 将高度角和方位角转换为3D坐标
                    const altitudeRad = altitude * Math.PI / 180;
                    const azimuthRad = (azimuth) * Math.PI / 180; // 方位角从北开始
                    
                    const distance = CELESTIAL_RADIUS;
                    const x = distance * Math.cos(altitudeRad) * Math.sin(azimuthRad);
                    const y = distance * Math.sin(altitudeRad);
                    const z = distance * Math.cos(altitudeRad) * Math.cos(azimuthRad);
                    
                    points.push(new THREE.Vector3(x, y, z));
                }
            }
            
            // 更新轨迹几何体
            trajectory.geometry.setFromPoints(points);
            trajectory.computeLineDistances();
        }
        
        // 更新观测者影子（简化处理）
        function updateShadow() {
            // 简化处理：根据太阳高度调整地面亮度
            const { altitude } = calculateSunPosition();
            const intensity = Math.max(0.3, Math.min(1, altitude / 90));
            ground.material.color.setRGB(0.3 * intensity, 0.7 * intensity, 0.3 * intensity);
        }
        
        // 窗口大小变化处理
        function onWindowResize() {
            const canvas = document.getElementById('earth-canvas');
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        }
        
        // 动画循环
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // 更新时间（如果正在播放）
            if (isPlaying) {
                time += 0.01; // 时间流逝速度
                if (time >= 24) time = 0;
                
                // 更新UI
                updateTimeUI();
                
                // 更新太阳位置
                updateSunPosition();
            }
            
            // 更新轨道控制
            controls.update();
            
            // 渲染场景
            renderer.render(scene, camera);
        }
        
        // 更新时间UI
        function updateTimeUI() {
            document.getElementById('time').value = time;
            
            const hour = Math.floor(time);
            const minute = Math.floor((time - hour) * 60);
            document.getElementById('time-value').textContent = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        }
        
        // 更新日期显示
        function updateDateValue() {
            const value = document.getElementById('date-value');
            value.textContent = dayOfYearToDate(date);
        }
        
        // 初始化UI事件
        function initUI() {
            // 纬度滑块
            const latitudeSlider = document.getElementById('latitude');
            const latitudeValue = document.getElementById('latitude-value');
            
            latitudeSlider.addEventListener('input', function() {
                latitude = parseFloat(this.value);
                latitudeValue.textContent = `${Math.abs(latitude)}°${latitude >= 0 ? 'N' : 'S'}`;
                updateSunPosition();
            });
            
            // 纬度按钮
            document.querySelectorAll('.latitude-buttons .option-button').forEach(button => {
                button.addEventListener('click', function() {
                    latitude = parseFloat(this.dataset.lat);
                    latitudeSlider.value = latitude;
                    latitudeValue.textContent = `${Math.abs(latitude)}°${latitude >= 0 ? 'N' : 'S'}`;
                    updateSunPosition();
                });
            });
            
            // 日期滑块
            const dateSlider = document.getElementById('date');
            
            dateSlider.addEventListener('input', function() {
                date = parseInt(this.value);
                updateDateValue();
                updateSunPosition();
            });
            
            // 时间滑块
            const timeSlider = document.getElementById('time');
            
            timeSlider.addEventListener('input', function() {
                time = parseFloat(this.value);
                updateTimeUI();
                updateSunPosition();
            });
            
            // 时间按钮
            document.querySelectorAll('.option-button[data-time]').forEach(button => {
                button.addEventListener('click', function() {
                    time = parseFloat(this.dataset.time);
                    timeSlider.value = time;
                    updateTimeUI();
                    updateSunPosition();
                });
            });
            
            // 播放/暂停按钮
            document.getElementById('play-pause').addEventListener('click', function() {
                isPlaying = !isPlaying;
                this.textContent = isPlaying ? '暂停' : '播放';
            });
            
            // 重置按钮
            document.getElementById('reset').addEventListener('click', function() {
                latitude = 40;
                date = 172;
                time = 12;
                
                latitudeSlider.value = latitude;
                dateSlider.value = date;
                timeSlider.value = time;
                
                latitudeValue.textContent = `${Math.abs(latitude)}°${latitude >= 0 ? 'N' : 'S'}`;
                updateDateValue();
                
                updateTimeUI();
                updateSunPosition();
                
                // 重置相机位置
                camera.position.set(0, 10, 15);
                controls.reset();
            });
            
            // 轨迹记录按钮
            document.getElementById('start-recording').addEventListener('click', startRecording);
            document.getElementById('pause-recording').addEventListener('click', pauseRecording);
            document.getElementById('clear-recording').addEventListener('click', clearRecording);
            
            // 季节按钮
            document.getElementById('spring-equinox').addEventListener('click', function() {
                date = SEASON_DATES['spring-equinox'];
                dateSlider.value = date;
                updateDateValue();
                updateSunPosition();
            });
            
            document.getElementById('summer-solstice').addEventListener('click', function() {
                date = SEASON_DATES['summer-solstice'];
                dateSlider.value = date;
                updateDateValue();
                updateSunPosition();
            });
            
            document.getElementById('autumn-equinox').addEventListener('click', function() {
                date = SEASON_DATES['autumn-equinox'];
                dateSlider.value = date;
                updateDateValue();
                updateSunPosition();
            });
            
            document.getElementById('winter-solstice').addEventListener('click', function() {
                date = SEASON_DATES['winter-solstice'];
                dateSlider.value = date;
                updateDateValue();
                updateSunPosition();
            });
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', function() {
            init();
            initUI();
            updateDateValue();
        });
    </script>
</body>
</html>